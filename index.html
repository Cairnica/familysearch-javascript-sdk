<!DOCTYPE html>

<html>
<head>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="familysearch-javascript-sdk.js"></script>
</head>

<body>
	<script>
    // ******************************************************************************************
    // Initialize the SDK
    // ******************************************************************************************
    FamilySearch.init({
      //app_key: 'KB2L-BVD1-3Q6S-J7X4-GKFZ-4168-QPZ6-NJRK', // production/staging
      app_key: 'WCQY-7J1Q-GKVV-7DNM-SQ5M-9Q5H-JX3H-CMJK', // Sandbox
      environment: 'sandbox',
      // auth_callback is the URI you registered with FamilySearch; it does not need to exist but it must have the same
      // host and port as the server for familysearch-javascript-sdk.js
      auth_callback: 'http://localhost:9000/#!/auth',
      http_function: jQuery.ajax,
      deferred_function: jQuery.Deferred,
      auto_signin: true,
      logging: true
    });

    // ******************************************************************************************
    // Get the access token
    // ******************************************************************************************
    function connect() {
      FamilySearch.getAccessToken().then(function(response) {
        console.log('accessToken response=',response);
        $("#login_link").hide();
        $("#loading").show();
        // ******************************************************************************************
        // Load current user
        // ******************************************************************************************
//        FamilySearch.getCurrentUser().then(function(response) {
//          $("#loading").hide();
//          $("#user_data").show();
//          $("#user_name").text(response.users[0].contactName);
//          $("#user_id").text(response.users[0].id);
//          console.log('current user id', response.users[0].treeUserId);
//        });
//        var promise = FamilySearch.getCurrentUserPerson().then(function(id) {
//          console.log('current user person',id);
//          return FamilySearch.getAncestry(id, 8).then(function(data) {
//            var ids = [];
//            for (var i = 0, len=data.persons.length; i < len; i++) {
//              ids.push(data.persons[i].id);
//            }
//            return FamilySearch.getMultiPerson(ids);
//          });
//        });
//        promise.then(function(persons) {
//          for (var id in persons) {
//            console.log('multi-persons', id, persons[id]);
//          }
//        });
        // use this to test throttling
        var names = ['williams','johnson','black','miller','taylor'];
        for (var n = 0; n < names.length; n++) {
          var name = names[n];
          FamilySearch.get('/platform/tree/search', {q: 'surname:'+name, count: 2000}, {Accept: 'application/x-gedcomx-atom+json'}).then(function(result) {
            var searchResultCnt = 0;
            for (var i = 0; i < result.entries.length; i++) {
              var persons = result.entries[i].content.gedcomx.persons;
              for (var j = 0; j < persons.length; j++) {
                var id = persons[j].id;
                searchResultCnt++;
                var promise = FamilySearch.getAncestry(id, 8).then(function(data) {
                  var ancs = [];
                  for (var k = 0; k < data.persons.length; k++) {
                    var anc = data.persons[k].id;
                    FamilySearch.get('/platform/tree/persons/'+anc+'/matches', {}, {Accept: 'application/x-gedcomx-atom+json'}).then(function() {
                      //console.log('.');
                    });
                    ancs.push(anc);
                  }
                  //console.log('REQUEST',ancs.length);
                  return FamilySearch.getMultiPerson(ancs);
                });
                promise.then(function(persons) {
                  var cnt = 0;
                  for (var id in persons) {
                    cnt++;
//                console.log('multi-persons', id, persons[id]);
                  }
                  //console.log('FULFILLED');
                });
              }
            }
            console.log('SEARCH RESULTS',searchResultCnt);
          });
        }
//        var ids = ['KW31-H9P','KWQ7-Y57','KW3B-NR5','KWQ7-Y57',"KW7S-VMM","KW7S-V4V","KW7S-V4J","KW7S-V4K","KWQ8-CTH","KWQ3-N36","KWQ9-T26","KWQ9-GXQ","KWQ8-6QQ","KW7S-VMM","KW7S-J11"];
//        for (var i = 0; i < 100; i++) {
//          for (var j = 0; j < ids.length; j++) {
//            var id = ids[j];
//            var promise = FamilySearch.getAncestry(id, 8).then(function(data) {
//              var ancs = [];
//              for (var k = 0; k < data.persons.length; k++) {
//                ancs.push(data.persons[k].id);
//              }
//              console.log('REQUEST',ancs.length);
//              return FamilySearch.getMultiPerson(ancs);
//            });
//            promise.then(function(persons) {
//              var cnt = 0;
//              for (var id in persons) {
//                cnt++;
////                console.log('multi-persons', id, persons[id]);
//              }
//              console.log('FULFILLED',cnt);
//            });
//          }
//        }
      });
    }
	</script>
	
	<div style="text-align:center; padding:30px; font-size:24px;">
		<div id="login_link">
			<a href="#" onClick="connect()">Connect with FamilySearch.</a>
		</div>	

		<div id="loading" style="display:none;">
			Please wait...
		</div>
    <div id="user_data" style="display:none">
      <h2>User information</h2>
      <p>
        <span style="color: lightgray">User name:</span> <span id="user_name"></span>
      </p>
      <p>
        <span style="color: lightgray">User id:</span> <span id="user_id"></span>
      </p>
    </div>
	</div>
	
</body>

</html>