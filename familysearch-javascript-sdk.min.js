/**
 * @preserve FamilySearch JavaScript SDK
 * (c) 2013, Dallan Quass & Dovy Paukstys
 * License: MIT
 */

!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.FamilySearch=t()}(this,function(){function e(e,t,r){n[e]={deps:3===arguments.length?t:[],fn:3===arguments.length?r:t}}function t(e){var o=n[e],s=[],i=o.fn;if("function"==typeof i){for(var c=0,u=o.deps.length;u>c;c++){var a=o.deps[c],p=r[a];void 0===p&&(p=t(a),r[a]=p),s.push(p)}i=o.fn.apply(this,s)}return i}var n={},r={};return e("globals",{appKey:null,environment:null,httpWrapper:null,deferredWrapper:null,authCallbackUri:null,autoSignin:!1,accessToken:null,saveAccessToken:!1,logging:!1,accessTokenCookie:"FS_ACCESS_TOKEN",authCodePollDelay:50,defaultThrottleRetryAfter:500,maxHttpRequestRetries:5,server:{sandbox:"https://sandbox.familysearch.org",staging:"https://stage.familysearch.org",production:"https://familysearch.org"},oauthServer:{sandbox:"https://sandbox.familysearch.org/cis-web/oauth2/v3",staging:"https://identbeta.familysearch.org/cis-web/oauth2/v3",production:"https://ident.familysearch.org/cis-web/oauth2/v3"}}),e("helpers",["globals"],function(e){var t={};return t.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"==Object.prototype.toString.call(e)},t.isNumber=function(e){return"[object Number]"==Object.prototype.toString.call(e)},t.isString=function(e){return"[object String]"==Object.prototype.toString.call(e)},t.isFunction=function(e){return"function"!=typeof/./?"function"==typeof e:"[object Function]"==Object.prototype.toString.call(e)},t.isObject=function(e){return e===Object(e)},t.isUndefined=function(e){return void 0===e},t.forEach=function(e,t,n){if(null!=e)if(Array.prototype.forEach&&e.forEach===Array.prototype.forEach)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,o=e.length;o>r;r++)if(t.call(n,e[r],r,e)==={})return}else for(var s in e)if(e.hasOwnProperty(s)&&t.call(n,e[s],s,e)==={})return},t.filter=function(e,n){var r=[];return t.forEach(e,function(e){n(e)&&r.push(e)}),r},t.map=function(e,n,r){var o=[];return t.forEach(e,function(e,t,s){o.push(n.call(r,e,t,s))}),o},t.uniq=function(e){for(var t={},n=[],r=0,o=e.length;o>r;r++){var s=e[r];t.hasOwnProperty(s)||(n.push(s),t[s]=1)}return n},t.findOrEmpty=function(e,n){var r={},o=t.isFunction(n);if(e)for(var s=0,i=e.length;i>s;s++){var c,u=e[s];if(o)c=n.call(null,u);else{c=!0;for(var a in n)if(n.hasOwnProperty(a)&&u[a]!==n[a]){c=!1;break}}if(c){r=u;break}}return r},t.firstOrEmpty=function(e){return e&&e.length>0?e[0]:{}},t.extend=function(e){return e=e||{},t.forEach(Array.prototype.slice.call(arguments,1),function(n){n&&t.forEach(n,function(t,n){e[n]=t})}),e},t.partialRight=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(this,Array.prototype.slice.call(arguments,0).concat(t))}},t.objectExtender=function(e,n){return n?function(r){return r&&t.forEach(n(r),function(n){t.extend(n,e)}),r}:t.partialRight(t.extend,e)},t.compose=function(){var e=arguments;return function(n){for(var r=e.length-1;r>=0;r--){var o=e[r];if(t.isArray(o))for(var s=o.length-1;s>=0;s--)n=o[s](n);else n=o(n)}return n}},t.wrapFunctions=function(e,n,r){return t.forEach(r,function(t){e[t]=function(){return n[t].apply(n,arguments)}}),e},t.extendHttpPromise=function(e,n){return t.wrapFunctions(e,n,["getResponseHeader","getAllResponseHeaders","getStatusCode"])},t.removeEmptyProperties=function(e){return t.forEach(e,function(t,n){(null==t||""===t)&&delete e[n]}),e},t.getAbsoluteUrl=function(e,t){return t.match(/^https?:\/\//)?t:e+("/"!==t.charAt(0)?"/":"")+t},t.encodeQueryString=function(e){var n=[];return t.forEach(e,function(e,t){n.push(encodeURIComponent(t)+"="+encodeURIComponent(e))}),n.join("&")},t.appendQueryParameters=function(e,n){var r=t.encodeQueryString(n);return 0===r.length?e:e+(e.indexOf("?")>=0?"&":"?")+r},t.decodeQueryString=function(e){var n={},r=e.substring(e.indexOf("?")+1).split("&");return t.forEach(r,function(e){var t=e.split("=",2);t&&t[0]&&(n[decodeURIComponent(t[0])]=decodeURIComponent(t[1]))}),n},t.nextTick=function(e){setTimeout(function(){e()},0)},t.refPromise=function(n){return n&&t.isFunction(n.then)?n:{then:function(r){var o=e.deferredWrapper();return t.nextTick(function(){o.resolve(r(n))}),o.promise}}},t.promiseAll=function(n){var r=e.deferredWrapper(),o=0,s=t.isArray(n)?[]:{};return t.forEach(n,function(e,n){o++,t.refPromise(e).then(function(e){s.hasOwnProperty(n)||(s[n]=e,--o||r.resolve(s))},function(){s.hasOwnProperty(n)||r.reject.apply(r,arguments)})}),0===o&&r.resolve(s),r.promise},t.createCookie=function(e,t,n){var r="";if(n){var o=new Date;o.setTime(o.getTime()+86400*n),r="; expires="+o.toUTCString()}document.cookie=e+"="+t+r+"; path=/"},t.readCookie=function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var o=n[r];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(t))return o.substring(t.length,o.length)}return null},t.eraseCookie=function(e){t.createCookie(e,"",-1)},t.eraseAccessToken=function(){e.accessToken=null,e.saveAccessToken&&t.eraseCookie(e.accessTokenCookie)},t}),e("jquery-wrappers",["globals","helpers"],function(e,t){var n={};return n.httpWrapper=function(n){return function(r,o,s,i,c){c=t.extend({url:o,type:r,dataType:"json",data:i},c),c.headers=t.extend({},s,c.headers);var u=n(c),a=e.deferredWrapper(),p=a.promise,f=null;return u.then(function(e,t,n){f=n.status,a.resolve(e)},function(e,t,n){f=e.status,a.reject(e,t,n)}),t.wrapFunctions(p,u,["getResponseHeader","getAllResponseHeaders"]),p.getStatusCode=function(){return f},p}},n.deferredWrapper=function(e){return function(){var t=e();return{promise:t.promise(),resolve:t.resolve,reject:t.reject}}},n}),e("init",["globals","jquery-wrappers","helpers"],function(e,t,n){var r={};return r.init=function(r){if(r=r||{},!r.app_key)throw"app_key must be set";if(e.appKey=r.app_key,!r.environment)throw"environment must be set";if(e.environment=r.environment,!r.http_function)throw"http must be set; e.g., jQuery.ajax";if(e.httpWrapper=t.httpWrapper(r.http_function),!r.deferred_function)throw"deferred_function must be set; e.g., jQuery.Deferred";e.deferredWrapper=t.deferredWrapper(r.deferred_function),r.auth_callback&&(e.authCallbackUri=r.auth_callback),r.auto_signin&&(e.autoSignin=r.auto_signin),r.save_access_token&&(e.saveAccessToken=!0,e.accessToken=n.readCookie(e.accessTokenCookie)),r.access_token&&(e.accessToken=r.access_token),e.logging=r.logging},r}),e("plumbing",["globals","helpers"],function(e,t){var n=0,r={};return r.getTotalProcessingTime=function(){return n},r.setTotalProcessingTime=function(e){n=e},r.get=function(e,n,o,s,i){return r.http("GET",t.appendQueryParameters(e,n),t.extend({Accept:"application/x-gedcomx-v1+json"},o),{},s,i)},r.post=function(e,n,o,s,i){return r.http("POST",e,t.extend({"Content-type":"application/x-www-form-urlencoded"},o),n,s,i)},r.put=function(e,n,o,s,i){return r.http("PUT",e,t.extend({"Content-type":"application/x-www-form-urlencoded"},o),n,s,i)},r.del=function(e,t,n,o){return r.http("DELETE",e,t,{},n,o)},r.http=function(o,s,i,c,u,a,p){var f=t.getAbsoluteUrl(e.server[e.environment],s);e.accessToken&&(f=t.appendQueryParameters(f,{access_token:e.accessToken})),null==p&&(p=e.maxHttpRequestRetries);var l=e.httpWrapper(o,f,i||{},c||{},u||{}),d=e.deferredWrapper(),h=t.extendHttpPromise(d.promise,l);return l.then(function(e){var t=l.getResponseHeader("X-PROCESSING-TIME");t&&(n+=parseInt(t,10)),a&&(e=a(e)),d.resolve(e)},function(){var n=l.getStatusCode();if(console.log("http failure",n,p,l.getAllResponseHeaders()),401===n&&t.eraseAccessToken(),p>0&&(429===n||401===n&&e.autoSignin)){var f=0;if(429===n){var g=l.getResponseHeader("Retry-After");console.log("retryAfter",g,l.getAllResponseHeaders()),f=g?parseInt(g,10):e.defaultThrottleRetryAfter}e.getAccessToken().then(function(){setTimeout(function(){l=r.http(o,s,i,c,u,a,p-1),t.extendHttpPromise(h,l),l.then(function(e){d.resolve(e)},function(){d.reject.apply(d,arguments)})},f)})}else d.reject.apply(d,arguments)}),h},r}),e("authentication",["globals","helpers","plumbing"],function(e,t,n){function r(e,n){var r=t.isUndefined(window.screenX)?window.screenLeft:window.screenX,o=t.isUndefined(window.screenY)?window.screenTop:window.screenY,s=t.isUndefined(window.outerWidth)?document.documentElement.clientWidth:window.outerWidth,i=t.isUndefined(window.outerHeight)?document.documentElement.clientHeight-22:window.outerHeight,c=n.width||780,u=n.height||500,a=parseInt(r+(s-c)/2,10),p=parseInt(o+(i-u)/2.5,10),f="width="+c+",height="+u+",left="+a+",top="+p;return window.open(t.appendQueryParameters(e,n),"",f)}function o(n){var r=e.deferredWrapper();if(n)var o=setInterval(function(){try{if(n.location.hostname===window.location.hostname){var e=t.decodeQueryString(n.location.href);clearInterval(o),n.close(),e.code?r.resolve(e.code):r.reject(e.error)}}catch(s){}},e.authCodePollDelay);else r.reject("Popup blocked");return r.promise}var s={};return s.getAuthCode=function(){var n=r(t.getAbsoluteUrl(e.oauthServer[e.environment],"authorization"),{response_type:"code",client_id:e.appKey,redirect_uri:e.authCallbackUri});return o(n)},e.getAccessToken=s.getAccessToken=function(r){var o=e.deferredWrapper();if(e.accessToken)t.nextTick(function(){o.resolve(e.accessToken)});else{var i;i=r?t.refPromise(r):s.getAuthCode(),i.then(function(r){var s=n.post(t.getAbsoluteUrl(e.oauthServer[e.environment],"token"),{grant_type:"authorization_code",code:r,client_id:e.appKey});s.then(function(n){e.accessToken=n.access_token,e.accessToken?(o.resolve(e.accessToken),e.saveAccessToken&&t.createCookie(e.accessTokenCookie,e.accessToken,0)):o.reject(n.error)},function(){o.reject.apply(o,arguments)})},function(){o.reject.apply(o,arguments)})}return o.promise},s.hasAccessToken=function(){return!!e.accessToken},s.invalidateAccessToken=function(){return t.eraseAccessToken(),n.del(t.getAbsoluteUrl(e.oauthServer[e.environment],"token"))},s}),e("user",["globals","helpers","plumbing"],function(e,t,n){function r(e,t){var n=null,r=t.getResponseHeader("Location");if(r||(r=t.getResponseHeader("Content-Location")),r){var o=r.match(/\/persons\/([^?]*)/);o&&(n=o[1])}n?e.resolve(n):e.reject("not found")}var o={};o.getCurrentUser=function(e){return n.get("/platform/users/current",{},{},e,t.objectExtender(s))};var s={getContactName:function(){return this.users[0].contactName},getFullName:function(){return this.users[0].fullName},getEmail:function(){return this.users[0].email},getId:function(){return this.users[0].id},getTreeUserId:function(){return this.users[0].treeUserId}};return o.getCurrentUserPerson=function(o){var s=n.get("/platform/tree/current-person",{},{},o),i=e.deferredWrapper(),c=t.extendHttpPromise(i.promise,s);return s.then(function(){r(i,s)},function(){r(i,s)}),c},o}),e("person",["helpers","plumbing"],function(e,t){function n(e,t){return e.father&&e.father.resourceId===t||e.mother&&e.mother.resourceId===t}var r={};r.getPerson=function(n,o,s){return o=o||{},t.get("/platform/tree/persons/"+encodeURI(n),o,{},s,e.compose(e.objectExtender({getPerson:function(){return this.persons[0]}}),r.personExtender))},r.personExtensionPointGetter=function(e){return e.persons};var o={getId:function(){return this.id},getBirthDate:function(){return this.display.birthDate},getBirthPlace:function(){return this.display.birthPlace},getDeathDate:function(){return this.display.deathDate},getDeathPlace:function(){return this.display.deathPlace},getGender:function(){return this.display.gender},getLifeSpan:function(){return this.display.lifespan},getName:function(){return this.display.name},isLiving:function(){return this.living},getGivenName:function(){return e.findOrEmpty(e.firstOrEmpty(e.findOrEmpty(this.names,{preferred:!0}).nameForms).parts,{type:"http://gedcomx.org/Given"}).value},getSurname:function(){return e.findOrEmpty(e.firstOrEmpty(e.findOrEmpty(this.names,{preferred:!0}).nameForms).parts,{type:"http://gedcomx.org/Surname"}).value},getDisplayAttrs:function(){return this.display}};r.personExtender=e.objectExtender(o,r.personExtensionPointGetter),r.getPersonNotes=function(n,r,o){return r=r||{},t.get("/platform/tree/persons/"+encodeURI(n)+"/notes",r,{},o,e.objectExtender({getNotes:function(){return this&&this.persons?this.persons[0].notes:[]}}))},r.getMultiPerson=function(t,n,o){var s={};return e.forEach(t,function(e){s[e]=r.getPerson(e,n,o)}),e.promiseAll(s)},r.getPersonWithRelationships=function(n,o,i){return o=o||{},t.get("/platform/tree/persons-with-relationships",e.removeEmptyProperties(e.extend({person:n},o)),{},i,e.compose(e.objectExtender(s),r.personExtender))};var s={getPerson:function(t){return e.findOrEmpty(this.persons,{id:t})},getPrimaryId:function(){return e.findOrEmpty(this.persons,function(e){return"1"===e.display.ascendancyNumber}).id},getPrimaryPerson:function(){return this.getPerson(this.getPrimaryId())},getFatherIds:function(){var t=this.getPrimaryId();return e.uniq(e.map(e.filter(this.childAndParentsRelationships,function(e){return e.child.resourceId===t&&e.father}),function(e){return e.father.resourceId}))},getFathers:function(){return e.map(this.getFatherIds(),this.getPerson,this)},getMotherIds:function(){var t=this.getPrimaryId();return e.uniq(e.map(e.filter(this.childAndParentsRelationships,function(e){return e.child.resourceId===t&&e.mother}),function(e){return e.mother.resourceId}))},getMothers:function(){return e.map(this.getMotherIds(),this.getPerson,this)},getParentsIds:function(){var t=this.getPrimaryId();return e.map(e.filter(this.childAndParentsRelationships,function(e){return e.child.resourceId===t&&(e.father||e.mother)}),function(e){return[e.father?e.father.resourceId:"",e.mother?e.mother.resourceId:""]})},getParents:function(){return e.map(this.getParentsIds(),function(e){return[this.getPerson(e[0]),this.getPerson(e[1])]},this)},getSpouseIds:function(){var t=this.getPrimaryId();return e.uniq(e.map(e.filter(this.relationships,function(e){return"http://gedcomx.org/Couple"===e.type&&(e.person1.resourceId===t||e.person2.resourceId===t)}),function(e){return e.person1.resourceId===t?e.person2.resourceId:e.person1.resourceId}))},getSpouses:function(){return e.map(this.getSpouseIds(),this.getPerson,this)},getChildIds:function(t){var r=this.getPrimaryId();return e.uniq(e.map(e.filter(this.childAndParentsRelationships,function(e){return n(e,r)&&(!t||n(e,t))}),function(e){return e.child.resourceId}))},getChildren:function(t){return e.map(this.getChildIds(t),this.getPerson,this)}};return r}),e("pedigree",["helpers","person","plumbing"],function(e,t,n){function r(t){return{getPersons:function(){return this.persons},exists:function(n){return!!e.findOrEmpty(this.persons,o(t,n)).id},getPerson:function(n){return e.findOrEmpty(this.persons,o(t,n))}}}function o(e,t){return function(n){return n.display[e]==t}}var s={};return s.getAncestry=function(o,s,i){return s=s||{},n.get("/platform/tree/ancestry",e.removeEmptyProperties(e.extend({person:o},s)),{},i,e.compose(e.objectExtender(r("ascendancyNumber")),t.personExtender,e.objectExtender({getAscendancyNumber:function(){return this.display.ascendancyNumber}},t.personExtensionPointGetter)))},s.getDescendancy=function(o,s,i){return s=s||{},n.get("/platform/tree/descendancy",e.removeEmptyProperties(e.extend({person:o},s)),{},i,e.compose(e.objectExtender(r("descendancyNumber")),t.personExtender,e.objectExtender({getDescendancyNumber:function(){return this.display.descendancyNumber}},t.personExtensionPointGetter)))},s}),e("FamilySearch",["init","authentication","user","person","pedigree","plumbing"],function(e,t,n,r,o,s){return{init:e.init,getAuthCode:t.getAuthCode,getAccessToken:t.getAccessToken,hasAccessToken:t.hasAccessToken,invalidateAccessToken:t.invalidateAccessToken,getCurrentUser:n.getCurrentUser,getCurrentUserPerson:n.getCurrentUserPerson,getPerson:r.getPerson,getPersonNotes:r.getPersonNotes,getMultiPerson:r.getMultiPerson,getPersonWithRelationships:r.getPersonWithRelationships,getAncestry:o.getAncestry,getDescendancy:o.getDescendancy,get:s.get,post:s.post,put:s.put,del:s.del,http:s.http,getTotalProcessingTime:s.getTotalProcessingTime,setTotalProcessingTime:s.setTotalProcessingTime}}),t("FamilySearch")});