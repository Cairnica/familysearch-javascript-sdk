/**
 * @preserve FamilySearch JavaScript SDK
 * (c) 2013, Dallan Quass & Dovy Paukstys
 * License: MIT
*/

/**
 * almond 0.2.7 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(e,t){"function"==typeof define&&define.amd?define(t):e.FamilySearch=t()}(this,function(){var e,t,n;return function(r){function o(e,t){return b.call(e,t)}function i(e,t){var n,r,o,i,s,u,c,a,p,f,l=t&&t.split("/"),d=v.map,h=d&&d["*"]||{};if(e&&"."===e.charAt(0))if(t){for(l=l.slice(0,l.length-1),e=l.concat(e.split("/")),a=0;a<e.length;a+=1)if(f=e[a],"."===f)e.splice(a,1),a-=1;else if(".."===f){if(1===a&&(".."===e[2]||".."===e[0]))break;a>0&&(e.splice(a-1,2),a-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((l||h)&&d){for(n=e.split("/"),a=n.length;a>0;a-=1){if(r=n.slice(0,a).join("/"),l)for(p=l.length;p>0;p-=1)if(o=d[l.slice(0,p).join("/")],o&&(o=o[r])){i=o,s=a;break}if(i)break;!u&&h&&h[r]&&(u=h[r],c=a)}!i&&u&&(i=u,s=c),i&&(n.splice(0,s,i),e=n.join("/"))}return e}function s(e,t){return function(){return d.apply(r,k.call(arguments,0).concat([e,t]))}}function u(e){return function(t){return i(t,e)}}function c(e){return function(t){m[e]=t}}function a(e){if(o(y,e)){var t=y[e];delete y[e],P[e]=!0,l.apply(r,t)}if(!o(m,e)&&!o(P,e))throw new Error("No "+e);return m[e]}function p(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function f(e){return function(){return v&&v.config&&v.config[e]||{}}}var l,d,h,g,m={},y={},v={},P={},b=Object.prototype.hasOwnProperty,k=[].slice;h=function(e,t){var n,r=p(e),o=r[0];return e=r[1],o&&(o=i(o,t),n=a(o)),o?e=n&&n.normalize?n.normalize(e,u(t)):i(e,t):(e=i(e,t),r=p(e),o=r[0],e=r[1],o&&(n=a(o))),{f:o?o+"!"+e:e,n:e,pr:o,p:n}},g={require:function(e){return s(e)},exports:function(e){var t=m[e];return"undefined"!=typeof t?t:m[e]={}},module:function(e){return{id:e,uri:"",exports:m[e],config:f(e)}}},l=function(e,t,n,i){var u,p,f,l,d,v,b=[],k=typeof n;if(i=i||e,"undefined"===k||"function"===k){for(t=!t.length&&n.length?["require","exports","module"]:t,d=0;d<t.length;d+=1)if(l=h(t[d],i),p=l.f,"require"===p)b[d]=g.require(e);else if("exports"===p)b[d]=g.exports(e),v=!0;else if("module"===p)u=b[d]=g.module(e);else if(o(m,p)||o(y,p)||o(P,p))b[d]=a(p);else{if(!l.p)throw new Error(e+" missing "+p);l.p.load(l.n,s(i,!0),c(p),{}),b[d]=m[p]}f=n?n.apply(m[e],b):void 0,e&&(u&&u.exports!==r&&u.exports!==m[e]?m[e]=u.exports:f===r&&v||(m[e]=f))}else e&&(m[e]=n)},e=t=d=function(e,t,n,o,i){return"string"==typeof e?g[e]?g[e](t):a(h(e,t).f):(e.splice||(v=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},"function"==typeof n&&(n=o,o=i),o?l(r,e,t,n):setTimeout(function(){l(r,e,t,n)},4),d)},d.config=function(e){return v=e,v.deps&&d(v.deps,v.callback),d},e._defined=m,n=function(e,t,n){t.splice||(n=t,t=[]),o(m,e)||o(y,e)||(y[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("globals",{appKey:null,environment:null,httpWrapper:null,deferredWrapper:null,authCallbackUri:null,autoSignin:!1,accessToken:null,saveAccessToken:!1,logging:!1,accessTokenCookie:"FS_ACCESS_TOKEN",authCodePollDelay:50,defaultThrottleRetryAfter:500,maxHttpRequestRetries:5,server:{sandbox:"https://sandbox.familysearch.org",staging:"https://stage.familysearch.org",production:"https://familysearch.org"},oauthServer:{sandbox:"https://sandbox.familysearch.org/cis-web/oauth2/v3",staging:"https://identbeta.familysearch.org/cis-web/oauth2/v3",production:"https://ident.familysearch.org/cis-web/oauth2/v3"}}),n("helpers",["globals"],function(e){var t={};return t.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"==Object.prototype.toString.call(e)},t.isNumber=function(e){return"[object Number]"==Object.prototype.toString.call(e)},t.isString=function(e){return"[object String]"==Object.prototype.toString.call(e)},t.isFunction=function(e){return"function"!=typeof/./?"function"==typeof e:"[object Function]"==Object.prototype.toString.call(e)},t.isObject=function(e){return e===Object(e)},t.isUndefined=function(e){return void 0===e},t.forEach=function(e,t,n){if(null!=e)if(Array.prototype.forEach&&e.forEach===Array.prototype.forEach)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,o=e.length;o>r;r++)if(t.call(n,e[r],r,e)==={})return}else for(var i in e)if(e.hasOwnProperty(i)&&t.call(n,e[i],i,e)==={})return},t.filter=function(e,n){var r=[];return t.forEach(e,function(e){n(e)&&r.push(e)}),r},t.map=function(e,n,r){var o=[];return t.forEach(e,function(e,t,i){o.push(n.call(r,e,t,i))}),o},t.uniq=function(e){for(var t={},n=[],r=0,o=e.length;o>r;r++){var i=e[r];t.hasOwnProperty(i)||(n.push(i),t[i]=1)}return n},t.findOrEmpty=function(e,n){var r={},o=t.isFunction(n);if(e)for(var i=0,s=e.length;s>i;i++){var u,c=e[i];if(o)u=n.call(null,c);else{u=!0;for(var a in n)if(n.hasOwnProperty(a)&&c[a]!==n[a]){u=!1;break}}if(u){r=c;break}}return r},t.firstOrEmpty=function(e){return e&&e.length>0?e[0]:{}},t.extend=function(e){return e=e||{},t.forEach(Array.prototype.slice.call(arguments,1),function(n){n&&t.forEach(n,function(t,n){e[n]=t})}),e},t.partialRight=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(this,Array.prototype.slice.call(arguments,0).concat(t))}},t.objectExtender=function(e,n){return n?function(r){return r&&t.forEach(n(r),function(n){t.extend(n,e)}),r}:t.partialRight(t.extend,e)},t.compose=function(){var e=arguments;return function(n){for(var r=e.length-1;r>=0;r--){var o=e[r];if(t.isArray(o))for(var i=o.length-1;i>=0;i--)n=o[i](n);else n=o(n)}return n}},t.wrapFunctions=function(e,n,r){return t.forEach(r,function(t){e[t]=function(){return n[t].apply(n,arguments)}}),e},t.extendHttpPromise=function(e,n){return t.wrapFunctions(e,n,["getResponseHeader","getAllResponseHeaders","getStatusCode"])},t.removeEmptyProperties=function(e){return t.forEach(e,function(t,n){(null==t||""===t)&&delete e[n]}),e},t.getAbsoluteUrl=function(e,t){return t.match(/^https?:\/\//)?t:e+("/"!==t.charAt(0)?"/":"")+t},t.encodeQueryString=function(e){var n=[];return t.forEach(e,function(e,t){n.push(encodeURIComponent(t)+"="+encodeURIComponent(e))}),n.join("&")},t.appendQueryParameters=function(e,n){var r=t.encodeQueryString(n);return 0===r.length?e:e+(e.indexOf("?")>=0?"&":"?")+r},t.decodeQueryString=function(e){var n={},r=e.substring(e.indexOf("?")+1).split("&");return t.forEach(r,function(e){var t=e.split("=",2);t&&t[0]&&(n[decodeURIComponent(t[0])]=decodeURIComponent(t[1]))}),n},t.nextTick=function(e){setTimeout(function(){e()},0)},t.refPromise=function(n){return n&&t.isFunction(n.then)?n:{then:function(r){var o=e.deferredWrapper();return t.nextTick(function(){o.resolve(r(n))}),o.promise}}},t.promiseAll=function(n){var r=e.deferredWrapper(),o=0,i=t.isArray(n)?[]:{};return t.forEach(n,function(e,n){o++,t.refPromise(e).then(function(e){i.hasOwnProperty(n)||(i[n]=e,--o||r.resolve(i))},function(){i.hasOwnProperty(n)||r.reject.apply(r,arguments)})}),0===o&&r.resolve(i),r.promise},t.createCookie=function(e,t,n){var r="";if(n){var o=new Date;o.setTime(o.getTime()+86400*n),r="; expires="+o.toUTCString()}document.cookie=e+"="+t+r+"; path=/"},t.readCookie=function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var o=n[r];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(t))return o.substring(t.length,o.length)}return null},t.eraseCookie=function(e){t.createCookie(e,"",-1)},t.eraseAccessToken=function(){e.accessToken=null,e.saveAccessToken&&t.eraseCookie(e.accessTokenCookie)},t}),n("jquery-wrappers",["globals","helpers"],function(e,t){var n={};return n.httpWrapper=function(n){return function(r,o,i,s,u){u=t.extend({url:o,type:r,dataType:"json",data:s},u),u.headers=t.extend({},i,u.headers);var c=n(u),a=e.deferredWrapper(),p=a.promise,f=null;return c.then(function(e,t,n){f=n.status,a.resolve(e)},function(e,t,n){f=e.status,a.reject(e,t,n)}),t.wrapFunctions(p,c,["getResponseHeader","getAllResponseHeaders"]),p.getStatusCode=function(){return f},p}},n.deferredWrapper=function(e){return function(){var t=e();return{promise:t.promise(),resolve:t.resolve,reject:t.reject}}},n}),n("init",["globals","jquery-wrappers","helpers"],function(e,t,n){var r={};return r.init=function(r){if(r=r||{},!r.app_key)throw"app_key must be set";if(e.appKey=r.app_key,!r.environment)throw"environment must be set";if(e.environment=r.environment,!r.http_function)throw"http must be set; e.g., jQuery.ajax";if(e.httpWrapper=t.httpWrapper(r.http_function),!r.deferred_function)throw"deferred_function must be set; e.g., jQuery.Deferred";e.deferredWrapper=t.deferredWrapper(r.deferred_function),r.auth_callback&&(e.authCallbackUri=r.auth_callback),r.auto_signin&&(e.autoSignin=r.auto_signin),r.save_access_token&&(e.saveAccessToken=!0,e.accessToken=n.readCookie(e.accessTokenCookie)),r.access_token&&(e.accessToken=r.access_token),e.logging=r.logging},r}),n("plumbing",["globals","helpers"],function(e,t){var n=0,r={};return r.getTotalProcessingTime=function(){return n},r.setTotalProcessingTime=function(e){n=e},r.get=function(e,n,o,i,s){return r.http("GET",t.appendQueryParameters(e,n),t.extend({Accept:"application/x-gedcomx-v1+json"},o),{},i,s)},r.post=function(e,n,o,i,s){return r.http("POST",e,t.extend({"Content-type":"application/x-www-form-urlencoded"},o),n,i,s)},r.put=function(e,n,o,i,s){return r.http("PUT",e,t.extend({"Content-type":"application/x-www-form-urlencoded"},o),n,i,s)},r.del=function(e,t,n,o){return r.http("DELETE",e,t,{},n,o)},r.http=function(o,i,s,u,c,a,p){var f=t.getAbsoluteUrl(e.server[e.environment],i);e.accessToken&&(f=t.appendQueryParameters(f,{access_token:e.accessToken})),null==p&&(p=e.maxHttpRequestRetries);var l=e.httpWrapper(o,f,s||{},u||{},c||{}),d=e.deferredWrapper(),h=t.extendHttpPromise(d.promise,l);return l.then(function(e){var t=l.getResponseHeader("X-PROCESSING-TIME");t&&(n+=parseInt(t,10)),a&&(e=a(e)),d.resolve(e)},function(){var n=l.getStatusCode();if(console.log("http failure",n,p,l.getAllResponseHeaders()),401===n&&t.eraseAccessToken(),p>0&&(429===n||401===n&&e.autoSignin)){var f=0;if(429===n){var g=l.getResponseHeader("Retry-After");console.log("retryAfter",g,l.getAllResponseHeaders()),f=g?parseInt(g,10):e.defaultThrottleRetryAfter}e.getAccessToken().then(function(){setTimeout(function(){l=r.http(o,i,s,u,c,a,p-1),t.extendHttpPromise(h,l),l.then(function(e){d.resolve(e)},function(){d.reject.apply(d,arguments)})},f)})}else d.reject.apply(d,arguments)}),h},r}),n("authentication",["globals","helpers","plumbing"],function(e,t,n){function r(e,n){var r=t.isUndefined(window.screenX)?window.screenLeft:window.screenX,o=t.isUndefined(window.screenY)?window.screenTop:window.screenY,i=t.isUndefined(window.outerWidth)?document.documentElement.clientWidth:window.outerWidth,s=t.isUndefined(window.outerHeight)?document.documentElement.clientHeight-22:window.outerHeight,u=n.width||780,c=n.height||500,a=parseInt(r+(i-u)/2,10),p=parseInt(o+(s-c)/2.5,10),f="width="+u+",height="+c+",left="+a+",top="+p;return window.open(t.appendQueryParameters(e,n),"",f)}function o(n){var r=e.deferredWrapper();if(n)var o=setInterval(function(){try{if(n.location.hostname===window.location.hostname){var e=t.decodeQueryString(n.location.href);clearInterval(o),n.close(),e.code?r.resolve(e.code):r.reject(e.error)}}catch(i){}},e.authCodePollDelay);else r.reject("Popup blocked");return r.promise}var i={};return i.getAuthCode=function(){var n=r(t.getAbsoluteUrl(e.oauthServer[e.environment],"authorization"),{response_type:"code",client_id:e.appKey,redirect_uri:e.authCallbackUri});return o(n)},e.getAccessToken=i.getAccessToken=function(r){var o=e.deferredWrapper();if(e.accessToken)t.nextTick(function(){o.resolve(e.accessToken)});else{var s;s=r?t.refPromise(r):i.getAuthCode(),s.then(function(r){var i=n.post(t.getAbsoluteUrl(e.oauthServer[e.environment],"token"),{grant_type:"authorization_code",code:r,client_id:e.appKey});i.then(function(n){e.accessToken=n.access_token,e.accessToken?(o.resolve(e.accessToken),e.saveAccessToken&&t.createCookie(e.accessTokenCookie,e.accessToken,0)):o.reject(n.error)},function(){o.reject.apply(o,arguments)})},function(){o.reject.apply(o,arguments)})}return o.promise},i.hasAccessToken=function(){return!!e.accessToken},i.invalidateAccessToken=function(){return t.eraseAccessToken(),n.del(t.getAbsoluteUrl(e.oauthServer[e.environment],"token"))},i}),n("user",["globals","helpers","plumbing"],function(e,t,n){function r(e,t){var n=null,r=t.getResponseHeader("Location");if(r||(r=t.getResponseHeader("Content-Location")),r){var o=r.match(/\/persons\/([^?]*)/);o&&(n=o[1])}n?e.resolve(n):e.reject("not found")}var o={};o.getCurrentUser=function(e){return n.get("/platform/users/current",{},{},e,t.objectExtender(i))};var i={getContactName:function(){return this.users[0].contactName},getFullName:function(){return this.users[0].fullName},getEmail:function(){return this.users[0].email},getId:function(){return this.users[0].id},getTreeUserId:function(){return this.users[0].treeUserId}};return o.getCurrentUserPerson=function(o){var i=n.get("/platform/tree/current-person",{},{},o),s=e.deferredWrapper(),u=t.extendHttpPromise(s.promise,i);return i.then(function(){r(s,i)},function(){r(s,i)}),u},o}),n("person",["helpers","plumbing"],function(e,t){function n(e,t){return e.father&&e.father.resourceId===t||e.mother&&e.mother.resourceId===t}var r={};r.getPerson=function(n,o,i){return o=o||{},t.get("/platform/tree/persons/"+encodeURI(n),o,{},i,e.compose(e.objectExtender({getPerson:function(){return this.persons[0]}}),r.personExtender))},r.personExtensionPointGetter=function(e){return e.persons};var o={getId:function(){return this.id},getBirthDate:function(){return this.display.birthDate},getBirthPlace:function(){return this.display.birthPlace},getDeathDate:function(){return this.display.deathDate},getDeathPlace:function(){return this.display.deathPlace},getGender:function(){return this.display.gender},getLifeSpan:function(){return this.display.lifespan},getName:function(){return this.display.name},isLiving:function(){return this.living},getGivenName:function(){return e.findOrEmpty(e.firstOrEmpty(e.findOrEmpty(this.names,{preferred:!0}).nameForms).parts,{type:"http://gedcomx.org/Given"}).value},getSurname:function(){return e.findOrEmpty(e.firstOrEmpty(e.findOrEmpty(this.names,{preferred:!0}).nameForms).parts,{type:"http://gedcomx.org/Surname"}).value},getDisplayAttrs:function(){return this.display}};r.personExtender=e.objectExtender(o,r.personExtensionPointGetter),r.getPersonNotes=function(n,r,o){return r=r||{},t.get("/platform/tree/persons/"+encodeURI(n)+"/notes",r,{},o,e.objectExtender({getNotes:function(){return this&&this.persons?this.persons[0].notes:[]}}))},r.getMultiPerson=function(t,n,o){var i={};return e.forEach(t,function(e){i[e]=r.getPerson(e,n,o)}),e.promiseAll(i)},r.getPersonWithRelationships=function(n,o,s){return o=o||{},t.get("/platform/tree/persons-with-relationships",e.removeEmptyProperties(e.extend({person:n},o)),{},s,e.compose(e.objectExtender(i),r.personExtender))};var i={getPerson:function(t){return e.findOrEmpty(this.persons,{id:t})},getPrimaryId:function(){return e.findOrEmpty(this.persons,function(e){return"1"===e.display.ascendancyNumber}).id},getPrimaryPerson:function(){return this.getPerson(this.getPrimaryId())},getFatherIds:function(){var t=this.getPrimaryId();return e.uniq(e.map(e.filter(this.childAndParentsRelationships,function(e){return e.child.resourceId===t&&e.father}),function(e){return e.father.resourceId}))},getFathers:function(){return e.map(this.getFatherIds(),this.getPerson,this)},getMotherIds:function(){var t=this.getPrimaryId();return e.uniq(e.map(e.filter(this.childAndParentsRelationships,function(e){return e.child.resourceId===t&&e.mother}),function(e){return e.mother.resourceId}))},getMothers:function(){return e.map(this.getMotherIds(),this.getPerson,this)},getParentsIds:function(){var t=this.getPrimaryId();return e.map(e.filter(this.childAndParentsRelationships,function(e){return e.child.resourceId===t&&(e.father||e.mother)}),function(e){return[e.father?e.father.resourceId:"",e.mother?e.mother.resourceId:""]})},getParents:function(){return e.map(this.getParentsIds(),function(e){return[this.getPerson(e[0]),this.getPerson(e[1])]},this)},getSpouseIds:function(){var t=this.getPrimaryId();return e.uniq(e.map(e.filter(this.relationships,function(e){return"http://gedcomx.org/Couple"===e.type&&(e.person1.resourceId===t||e.person2.resourceId===t)}),function(e){return e.person1.resourceId===t?e.person2.resourceId:e.person1.resourceId}))},getSpouses:function(){return e.map(this.getSpouseIds(),this.getPerson,this)},getChildIds:function(t){var r=this.getPrimaryId();return e.uniq(e.map(e.filter(this.childAndParentsRelationships,function(e){return n(e,r)&&(!t||n(e,t))}),function(e){return e.child.resourceId}))},getChildren:function(t){return e.map(this.getChildIds(t),this.getPerson,this)}};return r}),n("pedigree",["helpers","person","plumbing"],function(e,t,n){function r(t){return{getPersons:function(){return this.persons},exists:function(n){return!!e.findOrEmpty(this.persons,o(t,n)).id},getPerson:function(n){return e.findOrEmpty(this.persons,o(t,n))}}}function o(e,t){return function(n){return n.display[e]==t}}var i={};return i.getAncestry=function(o,i,s){return i=i||{},n.get("/platform/tree/ancestry",e.removeEmptyProperties(e.extend({person:o},i)),{},s,e.compose(e.objectExtender(r("ascendancyNumber")),t.personExtender,e.objectExtender({getAscendancyNumber:function(){return this.display.ascendancyNumber}},t.personExtensionPointGetter)))},i.getDescendancy=function(o,i,s){return i=i||{},n.get("/platform/tree/descendancy",e.removeEmptyProperties(e.extend({person:o},i)),{},s,e.compose(e.objectExtender(r("descendancyNumber")),t.personExtender,e.objectExtender({getDescendancyNumber:function(){return this.display.descendancyNumber}},t.personExtensionPointGetter)))},i}),n("FamilySearch",["init","authentication","user","person","pedigree","plumbing"],function(e,t,n,r,o,i){return{init:e.init,getAuthCode:t.getAuthCode,getAccessToken:t.getAccessToken,hasAccessToken:t.hasAccessToken,invalidateAccessToken:t.invalidateAccessToken,getCurrentUser:n.getCurrentUser,getCurrentUserPerson:n.getCurrentUserPerson,getPerson:r.getPerson,getPersonNotes:r.getPersonNotes,getMultiPerson:r.getMultiPerson,getPersonWithRelationships:r.getPersonWithRelationships,getAncestry:o.getAncestry,getDescendancy:o.getDescendancy,get:i.get,post:i.post,put:i.put,del:i.del,http:i.http,getTotalProcessingTime:i.getTotalProcessingTime,setTotalProcessingTime:i.setTotalProcessingTime}}),t("FamilySearch")});